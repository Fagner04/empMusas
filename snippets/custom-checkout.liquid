<!-- Checkout Customizado - Redirecionamento -->
<script>
(function() {
  // ========== CONFIGURAÇÕES - EDITE AQUI ==========
  var CHECKOUT_URL = "https://conectwhats.vercel.app/c/musasclub";
  var SKIP_CART = false; // true = redireciona direto do produto | false = passa pelo carrinho
  var DEBUG = true; // true = mostra logs no console (desative em produção)
  // ================================================

  // Expor variáveis globalmente para debug (opcional)
  window.__CUSTOM_CHECKOUT__ = { CHECKOUT_URL: CHECKOUT_URL, SKIP_CART: SKIP_CART, DEBUG: DEBUG };

  function log() {
    if (!DEBUG) return;
    var args = ['[custom-checkout]'].concat(Array.prototype.slice.call(arguments));
    try { console.log.apply(console, args); } catch (e) {}
  }

  log('Script carregado. SKIP_CART=' + SKIP_CART + ', CHECKOUT_URL=' + CHECKOUT_URL);

  function redirectTo(url) {
    log('Redirecionando para:', url);
    try {
      window.location.href = url;
    } catch (e) {
      window.location = url;
    }
  }

  // Seletores de botões de checkout (ampliados)
  var CHECKOUT_SELECTORS = [
    '[name="checkout"]',
    '[type="submit"][name="checkout"]',
    '.shopify-payment-button',
    '.shopify-payment-button__button',
    '[data-checkout-url]',
    'button[name="checkout"]',
    'input[name="checkout"]',
    '.cart__checkout-button',
    '.cart__checkout',
    '.cart-checkout-button',
    '[href*="/checkout"]',
    '[href*="/checkouts"]',
    '.checkout-button',
    '#checkout',
    '#CartSubmit',
    '[data-action="checkout"]',
    '[data-cart-checkout]',
    '.cart__submit',
    '.cart-drawer__checkout',
    'form[action*="/checkout"] button',
    'form[action*="/checkout"] input[type="submit"]',
    'form[action*="/checkouts"] button',
    'form[action*="/checkouts"] input[type="submit"]',
    '.cart__ctas button',
    '.cart-drawer__cta button',
    '[data-checkout]',
    '.btn--checkout'
  ].join(', ');
  
  // Redirecionar com itens do carrinho
  function redirectWithCart() {
    log('Buscando itens do carrinho...');
    var didRedirect = false;
    var fallbackTimer = setTimeout(function() {
      if (didRedirect) return;
      didRedirect = true;
      log('Timeout - redirecionando sem itens');
      redirectTo(CHECKOUT_URL);
    }, 2500);

    try {
      if (!window.fetch) {
        log('Fetch não disponível, redirecionando direto');
        clearTimeout(fallbackTimer);
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
        return;
      }

      fetch('/cart.js', { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .then(function(cart) {
          if (didRedirect) return;
          clearTimeout(fallbackTimer);

          log('Carrinho obtido:', cart.items ? cart.items.length + ' itens' : 'vazio');

          if (cart && cart.items && cart.items.length > 0) {
            var cartParam = encodeURIComponent(cart.items.map(function(item) {
              return String(item.variant_id) + ':' + String(item.quantity);
            }).join(','));

            didRedirect = true;
            redirectTo(CHECKOUT_URL + "?cart=" + cartParam);
          } else {
            didRedirect = true;
            redirectTo(CHECKOUT_URL);
          }
        })
        .catch(function(err) {
          log('Erro ao buscar /cart.js:', err);
          if (didRedirect) return;
          clearTimeout(fallbackTimer);
          didRedirect = true;
          redirectTo(CHECKOUT_URL);
        });
    } catch (err) {
      log('Erro inesperado:', err);
      clearTimeout(fallbackTimer);
      if (!didRedirect) {
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
      }
    }
  }
  
  // ===== INTERCEPTAÇÃO DE SUBMIT =====
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (!form || form.tagName !== 'FORM') return;

    var submitter = e.submitter || document.activeElement;
    var formaction = (submitter && submitter.getAttribute) ? submitter.getAttribute('formaction') : '';
    var action = (formaction || form.action || '').toLowerCase();

    log('Submit capturado:', { action: action, submitter: submitter ? submitter.outerHTML.substring(0, 100) : 'nenhum' });

    // Detectar se é checkout
    var submitterIsCheckout = !!(submitter && submitter.closest && submitter.closest(CHECKOUT_SELECTORS));
    var actionIsCheckout = action.indexOf('/checkout') !== -1 || action.indexOf('/checkouts') !== -1;
    var submitterNameCheckout = !!(submitter && submitter.name === 'checkout');

    if (submitterIsCheckout || actionIsCheckout || submitterNameCheckout) {
      log('>>> CHECKOUT detectado via SUBMIT - interceptando');
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }

    // SKIP_CART=true: interceptar add-to-cart
    if (SKIP_CART && (action.indexOf('/cart/add') !== -1)) {
      var productInput = form.querySelector('[name="id"]');
      if (!productInput) return;

      log('>>> ADD-TO-CART detectado - interceptando');
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      var quantityInput = form.querySelector('[name="quantity"]');
      var productId = productInput.value;
      var quantity = quantityInput ? quantityInput.value : 1;
      redirectTo(CHECKOUT_URL + "/" + productId + "?quantity=" + quantity);
      return false;
    }
  }, true);
  
  // ===== INTERCEPTAÇÃO DE CLICK =====
  document.addEventListener('click', function(e) {
    if (!e.target) return;

    // Buscar elemento clicado ou ancestral que case com seletores
    var target = e.target;
    var matched = null;

    // Tentar match direto e ancestrais
    if (target.matches && target.matches(CHECKOUT_SELECTORS)) {
      matched = target;
    } else if (target.closest) {
      matched = target.closest(CHECKOUT_SELECTORS);
    }

    if (matched) {
      log('>>> CLICK em elemento checkout detectado:', matched.outerHTML.substring(0, 150));
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }

    // Log de cliques para debug (quando DEBUG=true)
    if (DEBUG) {
      var tagInfo = target.tagName + (target.name ? '[name=' + target.name + ']' : '') + (target.className ? '.' + String(target.className).split(' ').join('.') : '');
      log('Click em:', tagInfo);
    }
  }, true);

  // ===== PATCH DE location.assign/replace =====
  function patchLocationMethod(methodName) {
    try {
      var original = window.location[methodName];
      if (typeof original !== 'function') return;

      Object.defineProperty(window.location, methodName, {
        value: function(url) {
          try {
            if (typeof url === 'string' && (url.indexOf('/checkout') !== -1 || url.indexOf('/checkouts') !== -1)) {
              log('>>> location.' + methodName + ' para checkout interceptado:', url);
              redirectWithCart();
              return;
            }
          } catch (e) {}
          return original.call(window.location, url);
        },
        writable: true,
        configurable: true
      });
      log('Patched location.' + methodName);
    } catch (e) {
      log('Não foi possível fazer patch de location.' + methodName);
    }
  }

  patchLocationMethod('assign');
  patchLocationMethod('replace');

  // Log dos seletores de checkout encontrados na página
  setTimeout(function() {
    try {
      var found = document.querySelectorAll(CHECKOUT_SELECTORS);
      log('Elementos de checkout encontrados na página:', found.length);
      for (var i = 0; i < Math.min(found.length, 5); i++) {
        log('  -', found[i].outerHTML.substring(0, 120));
      }
    } catch (e) {}
  }, 1000);
})();
</script>