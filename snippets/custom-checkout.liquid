<!-- Checkout Customizado - Redirecionamento -->
<script>
(function() {
  var CHECKOUT_URL = "https://conectwhats.vercel.app/c/musasclub";
  var SKIP_CART = true; // true = redireciona direto | false = passa pelo carrinho primeiro
  var DEBUG = true; // se ainda falhar, mude para true e me mande print do console

  function log() {
    if (!DEBUG || !window.console) return;
    try { console.log.apply(console, arguments); } catch (e) {}
  }

  function redirectTo(url) {
    try {
      log('[custom-checkout] redirect →', url);
      window.location.href = url;
    } catch (e) {
      window.location = url;
    }
  }

  var CHECKOUT_SELECTORS = [
    '[name="checkout"]',
    '[type="submit"][name="checkout"]',
    '.shopify-payment-button',
    '.shopify-payment-button__button',
    '[data-checkout-url]',
    'button[name="checkout"]',
    'input[name="checkout"]',
    '.cart__checkout-button',
    '.cart__checkout',
    '.cart-checkout-button',
    '[href*="/checkout"]',
    '[href*="/checkouts"]',
    '.checkout-button',
    '#checkout',
    '#CartSubmit',
    '[data-action="checkout"]',
    '[data-cart-checkout]',
    '.cart__submit',
    '.cart-drawer__checkout',
    'form[action*="/checkout"] button',
    'form[action*="/checkout"] input[type="submit"]',
    'form[action*="/checkouts"] button',
    'form[action*="/checkouts"] input[type="submit"]'
  ].join(', ');

  function redirectWithCart() {
    var didRedirect = false;
    var fallbackTimer = setTimeout(function() {
      if (didRedirect) return;
      didRedirect = true;
      redirectTo(CHECKOUT_URL);
    }, 2500);

    try {
      if (!window.fetch) {
        clearTimeout(fallbackTimer);
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
        return;
      }

      fetch('/cart.js', { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .then(function(cart) {
          if (didRedirect) return;
          clearTimeout(fallbackTimer);

          if (cart && cart.items && cart.items.length > 0) {
            var cartParam = encodeURIComponent(cart.items.map(function(item) {
              return String(item.variant_id) + ':' + String(item.quantity);
            }).join(','));

            didRedirect = true;
            redirectTo(CHECKOUT_URL + "?cart=" + cartParam);
          } else {
            didRedirect = true;
            redirectTo(CHECKOUT_URL);
          }
        })
        .catch(function(err) {
          log('[custom-checkout] erro ao buscar /cart.js:', err);
          if (didRedirect) return;
          clearTimeout(fallbackTimer);
          didRedirect = true;
          redirectTo(CHECKOUT_URL);
        });
    } catch (err) {
      log('[custom-checkout] erro inesperado:', err);
      clearTimeout(fallbackTimer);
      if (!didRedirect) {
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
      }
    }
  }

  // submit (captura)
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (!form || !form.action) return;

    var submitter = e.submitter || document.activeElement;
    var formaction = submitter && submitter.getAttribute ? submitter.getAttribute('formaction') : '';
    var action = (formaction || form.action || '').toLowerCase();

    // SKIP_CART=true: intercepta add-to-cart
    if (SKIP_CART && action.includes('/cart')) {
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();

      var productInput = form.querySelector('[name="id"]');
      var quantityInput = form.querySelector('[name="quantity"]');

      if (productInput) {
        var productId = productInput.value;
        var quantity = quantityInput ? quantityInput.value : 1;
        redirectTo(CHECKOUT_URL + "/" + productId + "?quantity=" + quantity);
      }
      return false;
    }

    // SKIP_CART=false: só intercepta se o submitter for checkout (evita travar “atualizar carrinho”)
    if (!SKIP_CART) {
      var submitterIsCheckout = !!(submitter && submitter.closest && submitter.closest(CHECKOUT_SELECTORS));
      var actionIsCheckout = action.includes('/checkout') || action.includes('/checkouts');
      if (!submitterIsCheckout && !actionIsCheckout) return;

      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }
  }, true);

  // click (captura)
  document.addEventListener('click', function(e) {
    if (SKIP_CART) return;
    if (!e.target || !e.target.closest) return;

    var target = e.target.closest(CHECKOUT_SELECTORS);
    if (!target) return;

    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    redirectWithCart();
    return false;
  }, true);

  // fallback: temas que fazem checkout via location.assign/replace
  function patchLocationMethod(methodName) {
    try {
      var original = window.location[methodName].bind(window.location);
      window.location[methodName] = function(url) {
        try {
          if (!SKIP_CART && typeof url === 'string' && (url.indexOf('/checkout') !== -1 || url.indexOf('/checkouts') !== -1)) {
            redirectWithCart();
            return;
          }
        } catch (e) {}
        return original(url);
      };
    } catch (e) {}
  }
  patchLocationMethod('assign');
  patchLocationMethod('replace');
})();
</script>
