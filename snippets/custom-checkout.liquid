<!-- Checkout Customizado - Redirecionamento -->
<script>
(function() {
  // Configurações - EDITE AQUI
  var CHECKOUT_URL = "https://conectwhats.vercel.app/c/musasclub";
  var SKIP_CART = false; // true = redireciona direto | false = passa pelo carrinho primeiro
  
  // Função para redirecionar com itens do carrinho
  function redirectWithCart() {
    fetch('/cart.js')
      .then(function(r) { return r.json(); })
      .then(function(cart) {
        if (cart.items && cart.items.length > 0) {
          var items = encodeURIComponent(JSON.stringify(cart.items.map(function(item) {
            return { id: item.variant_id, qty: item.quantity, name: item.title, price: item.price / 100, img: item.image };
          })));
          window.location.href = CHECKOUT_URL + "?items=" + items;
        } else {
          window.location.href = CHECKOUT_URL;
        }
      })
      .catch(function() {
        window.location.href = CHECKOUT_URL;
      });
  }
  
  // Interceptar formulário de add to cart (SKIP_CART = true) OU checkout (SKIP_CART = false)
  document.addEventListener('submit', function(e) {
    var form = e.target;
    var action = form.action || '';
    
    // Se SKIP_CART = true, intercepta add to cart
    if (SKIP_CART && action.includes('/cart')) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      var productInput = form.querySelector('[name="id"]');
      var quantityInput = form.querySelector('[name="quantity"]');
      
      if (productInput) {
        var productId = productInput.value;
        var quantity = quantityInput ? quantityInput.value : 1;
        window.location.href = CHECKOUT_URL + "/" + productId + "?quantity=" + quantity;
      }
      return false;
    }
    
    // Se SKIP_CART = false, intercepta o formulário de checkout na página do carrinho
    if (!SKIP_CART && (action.includes('/checkout') || form.querySelector('[name="checkout"]'))) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }
  }, true);
  
  // Interceptar clique em botões de checkout (seletores ampliados para mais temas)
  document.addEventListener('click', function(e) {
    var checkoutSelectors = [
      '[name="checkout"]',
      '[type="submit"][name="checkout"]',
      '.shopify-payment-button',
      '.shopify-payment-button__button',
      '[data-checkout-url]',
      'button[name="checkout"]',
      'input[name="checkout"]',
      '.cart__checkout-button',
      '.cart__checkout',
      '.cart-checkout-button',
      '[href*="/checkout"]',
      '[href*="/checkouts"]',
      '.checkout-button',
      '#checkout',
      '#CartSubmit',
      '[data-action="checkout"]',
      '[data-cart-checkout]',
      '.cart__submit',
      '.cart-drawer__checkout',
      'form[action*="/checkout"] button',
      'form[action*="/checkout"] input[type="submit"]'
    ].join(', ');
    
    var target = e.target.closest(checkoutSelectors);
    if (target) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }
  }, true);
  
  // Interceptar submit de formulários de checkout
  document.querySelectorAll('form[action*="/checkout"], form[action*="/checkouts"]').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }, true);
  });
  
  // Interceptar navegação para /checkout (fallback)
  var originalPushState = history.pushState;
  history.pushState = function() {
    originalPushState.apply(history, arguments);
    if (window.location.pathname.includes('/checkout')) {
      redirectWithCart();
    }
  };
  
  // Monitorar mudanças no DOM para novos botões de checkout
  var observer = new MutationObserver(function() {
    document.querySelectorAll('form[action*="/checkout"], form[action*="/checkouts"]').forEach(function(form) {
      if (!form.dataset.checkoutIntercepted) {
        form.dataset.checkoutIntercepted = 'true';
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          redirectWithCart();
          return false;
        }, true);
      }
    });
  });
  observer.observe(document.body, { childList: true, subtree: true });
  
  // Verificar se já estamos no checkout
  if (window.location.pathname.includes('/checkout')) {
    redirectWithCart();
  }
})();
</script>