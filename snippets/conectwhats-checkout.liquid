<!-- Checkout Customizado - Redirecionamento -->
<script>
(function() {
  // ========== CONFIGURAÇÕES - EDITE AQUI ==========
  var CHECKOUT_URL = "https://conectwhats.vercel.app/c/musasclub";
  var SKIP_CART = false; // true = redireciona direto do produto | false = passa pelo carrinho
  var DEBUG = true; // true = mostra logs no console (desative em produção)
  // ================================================

  // Expor variáveis globalmente para debug
  window.__CC__ = { url: CHECKOUT_URL, skip: SKIP_CART, debug: DEBUG };

  function log() {
    if (!DEBUG) return;
    var args = ['[custom-checkout]'].concat(Array.prototype.slice.call(arguments));
    try { console.log.apply(console, args); } catch (e) {}
  }

  log('✓ Script carregado. SKIP_CART=' + SKIP_CART);

  function redirectTo(url) {
    log('→ Redirecionando para:', url);
    try { window.location.href = url; } catch (e) { window.location = url; }
  }

  // SELETORES SUPER AMPLIADOS para máxima compatibilidade
  var CHECKOUT_SELECTORS = [
    // Forms e inputs
    '[name="checkout"]',
    '[type="submit"][name="checkout"]',
    'button[name="checkout"]',
    'input[name="checkout"]',
    
    // Shopify padrão
    '.shopify-payment-button',
    '.shopify-payment-button__button',
    '.shopify-payment-button button',
    '[data-checkout-url]',
    '[data-checkout]',
    '[data-action="checkout"]',
    '[data-cart-checkout]',
    
    // Classes comuns de checkout
    '.cart__checkout-button',
    '.cart__checkout',
    '.cart-checkout-button',
    '.checkout-button',
    '.cart__submit',
    '.cart-drawer__checkout',
    '.cart__ctas button',
    '.cart-drawer__cta button',
    '.btn--checkout',
    '.button--checkout',
    '#checkout',
    '#CartSubmit',
    
    // Forms de checkout
    'form[action*="/checkout"] button',
    'form[action*="/checkout"] input[type="submit"]',
    'form[action*="/checkouts"] button',
    'form[action*="/checkouts"] input[type="submit"]',
    'form[action="/cart"] button[type="submit"]',
    
    // Links de checkout
    '[href*="/checkout"]',
    '[href*="/checkouts"]',
    'a[href$="/checkout"]',
    
    // Dawn, Debut, Brooklyn themes
    '.cart-notification__checkout',
    '.cart-drawer-item__checkout',
    '#cart-notification-button',
    '.ajax-cart__checkout',
    
    // Texto do botão (fallback)
    'button:not([type="button"])'
  ].join(', ');
  
  // Palavras-chave que indicam checkout
  var CHECKOUT_KEYWORDS = ['checkout', 'finalizar', 'comprar', 'buy', 'purchase', 'proceed', 'pagar'];
  
  function isCheckoutElement(el) {
    if (!el) return false;
    
    // Match por seletor
    try {
      if (el.matches && el.matches(CHECKOUT_SELECTORS)) return true;
    } catch (e) {}
    
    // Match por texto do botão
    var text = (el.textContent || el.innerText || '').toLowerCase().trim();
    for (var i = 0; i < CHECKOUT_KEYWORDS.length; i++) {
      if (text.indexOf(CHECKOUT_KEYWORDS[i]) !== -1) {
        // Verificar se é botão/link
        if (el.tagName === 'BUTTON' || el.tagName === 'A' || el.tagName === 'INPUT') {
          return true;
        }
      }
    }
    
    // Match por href
    var href = el.getAttribute && el.getAttribute('href');
    if (href && (href.indexOf('/checkout') !== -1 || href.indexOf('/checkouts') !== -1)) {
      return true;
    }
    
    return false;
  }
  
  // Redirecionar com itens do carrinho
  function redirectWithCart() {
    log('Buscando itens do carrinho...');
    var didRedirect = false;
    var fallbackTimer = setTimeout(function() {
      if (didRedirect) return;
      didRedirect = true;
      log('Timeout - redirecionando sem itens');
      redirectTo(CHECKOUT_URL);
    }, 2500);

    try {
      if (!window.fetch) {
        log('Fetch não disponível');
        clearTimeout(fallbackTimer);
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
        return;
      }

      fetch('/cart.js', { credentials: 'same-origin', cache: 'no-store' })
        .then(function(r) { return r.json(); })
        .then(function(cart) {
          if (didRedirect) return;
          clearTimeout(fallbackTimer);

          log('Carrinho:', cart.items ? cart.items.length + ' itens' : 'vazio');

          if (cart && cart.items && cart.items.length > 0) {
            var cartParam = encodeURIComponent(cart.items.map(function(item) {
              return String(item.variant_id) + ':' + String(item.quantity);
            }).join(','));

            didRedirect = true;
            redirectTo(CHECKOUT_URL + "?cart=" + cartParam);
          } else {
            didRedirect = true;
            redirectTo(CHECKOUT_URL);
          }
        })
        .catch(function(err) {
          log('Erro /cart.js:', err);
          if (didRedirect) return;
          clearTimeout(fallbackTimer);
          didRedirect = true;
          redirectTo(CHECKOUT_URL);
        });
    } catch (err) {
      log('Erro:', err);
      clearTimeout(fallbackTimer);
      if (!didRedirect) {
        didRedirect = true;
        redirectTo(CHECKOUT_URL);
      }
    }
  }
  
  // ===== INTERCEPTAR FORMS DE CHECKOUT DIRETAMENTE =====
  function attachToCheckoutForms() {
    try {
      // Encontrar todos os forms que contêm botões de checkout
      var forms = document.querySelectorAll('form');
      log('Forms encontrados:', forms.length);
      
      forms.forEach(function(form) {
        if (form.__ccFormAttached) return;
        
        var action = (form.action || '').toLowerCase();
        var hasCheckoutButton = form.querySelector('[name="checkout"], [type="submit"][name="checkout"], .cart__checkout-button, .checkout-button');
        var isCheckoutForm = action.indexOf('/checkout') !== -1 || action.indexOf('/cart') !== -1;
        
        if (hasCheckoutButton || isCheckoutForm) {
          form.__ccFormAttached = true;
          log('✓ Form de checkout detectado:', action.substring(0, 50));
          
          // Listener de submit com alta prioridade
          form.addEventListener('submit', function(e) {
            var submitter = e.submitter || document.activeElement;
            var submitterName = submitter ? (submitter.name || '').toLowerCase() : '';
            var submitterText = submitter ? (submitter.textContent || '').toLowerCase() : '';
            
            // Verificar se é o botão de checkout
            if (submitterName === 'checkout' || 
                submitterText.indexOf('checkout') !== -1 || 
                submitterText.indexOf('finalizar') !== -1 ||
                submitterText.indexOf('comprar') !== -1) {
              log('>>> FORM SUBMIT interceptado!');
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              redirectWithCart();
              return false;
            }
            
            // Verificar action do form
            var formAction = (e.target.action || '').toLowerCase();
            if (formAction.indexOf('/checkout') !== -1 && formAction.indexOf('/cart') === -1) {
              log('>>> FORM ACTION /checkout interceptado!');
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              redirectWithCart();
              return false;
            }
          }, true);
          
          // Também interceptar clicks nos botões do form
          var buttons = form.querySelectorAll('button, input[type="submit"]');
          buttons.forEach(function(btn) {
            if (btn.__ccBtnAttached) return;
            btn.__ccBtnAttached = true;
            
            var name = (btn.name || '').toLowerCase();
            var text = (btn.textContent || btn.value || '').toLowerCase();
            
            if (name === 'checkout' || text.indexOf('checkout') !== -1 || text.indexOf('finalizar') !== -1) {
              log('✓ Botão checkout no form:', text.substring(0, 20));
              
              btn.addEventListener('click', function(e) {
                log('>>> BOTÃO no FORM clicado!');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Prevenir submit do form
                if (form) {
                  form.onsubmit = function() { return false; };
                }
                
                redirectWithCart();
                return false;
              }, true);
            }
          });
        }
      });
    } catch (e) {
      log('Erro ao anexar forms:', e);
    }
  }

  // ===== INTERCEPTAÇÃO DE SUBMIT GLOBAL =====
  document.addEventListener('submit', function(e) {
    var form = e.target;
    if (!form || form.tagName !== 'FORM') return;

    var submitter = e.submitter || document.activeElement;
    var formaction = (submitter && submitter.getAttribute) ? submitter.getAttribute('formaction') : '';
    var action = (formaction || form.action || '').toLowerCase();

    log('Submit global:', action.substring(0, 50));

    // Verificar nome do submitter
    var submitterName = (submitter && submitter.name) ? submitter.name.toLowerCase() : '';
    var submitterText = (submitter && submitter.textContent) ? submitter.textContent.toLowerCase() : '';
    
    var isCheckout = submitterName === 'checkout' ||
                     submitterText.indexOf('checkout') !== -1 ||
                     submitterText.indexOf('finalizar') !== -1 ||
                     action.indexOf('/checkout') !== -1;

    if (isCheckout && action.indexOf('/cart/add') === -1) {
      log('>>> CHECKOUT via SUBMIT GLOBAL interceptado!');
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }

    // SKIP_CART=true: interceptar add-to-cart
    if (SKIP_CART && (action.indexOf('/cart/add') !== -1)) {
      var productInput = form.querySelector('[name="id"]');
      if (!productInput) return;

      log('>>> ADD-TO-CART interceptado!');
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      var quantityInput = form.querySelector('[name="quantity"]');
      var productId = productInput.value;
      var quantity = quantityInput ? quantityInput.value : 1;
      redirectTo(CHECKOUT_URL + "/" + productId + "?quantity=" + quantity);
      return false;
    }
  }, true);
  
  // ===== INTERCEPTAÇÃO DE CLICK =====
  document.addEventListener('click', function(e) {
    if (!e.target) return;

    var target = e.target;
    var matched = null;

    // Checar elemento clicado e ancestrais
    var current = target;
    for (var i = 0; i < 5 && current; i++) {
      if (isCheckoutElement(current)) {
        matched = current;
        break;
      }
      current = current.parentElement;
    }

    if (matched) {
      log('>>> CLICK em checkout detectado!', matched.tagName, (matched.textContent || '').substring(0, 30));
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // Se estiver em um form, prevenir submit
      var form = matched.closest('form');
      if (form) {
        form.onsubmit = function() { return false; };
      }
      
      redirectWithCart();
      return false;
    }
  }, true);

  // ===== INTERCEPTAR TODOS OS LINKS DE CHECKOUT =====
  document.addEventListener('click', function(e) {
    var link = e.target.closest && e.target.closest('a');
    if (!link) return;
    
    var href = link.getAttribute('href') || '';
    if (href.indexOf('/checkout') !== -1 || href.indexOf('/checkouts') !== -1) {
      log('>>> LINK de checkout interceptado!', href);
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      redirectWithCart();
      return false;
    }
  }, true);

  // ===== PATCH DE location.assign/replace =====
  function patchLocationMethod(methodName) {
    try {
      var original = window.location[methodName];
      if (typeof original !== 'function') {
        log('Não foi possível fazer patch de location.' + methodName);
        return;
      }

      Object.defineProperty(window.location, methodName, {
        value: function(url) {
          try {
            if (typeof url === 'string' && (url.indexOf('/checkout') !== -1 || url.indexOf('/checkouts') !== -1)) {
              log('>>> location.' + methodName + ' interceptado!');
              redirectWithCart();
              return;
            }
          } catch (e) {}
          return original.call(window.location, url);
        },
        writable: true,
        configurable: true
      });
      log('✓ Patched location.' + methodName);
    } catch (e) {
      log('Não foi possível fazer patch de location.' + methodName);
    }
  }

  patchLocationMethod('assign');
  patchLocationMethod('replace');

  // ===== MONITORAR ELEMENTOS DINÂMICOS =====
  function attachToCheckoutButtons() {
    try {
      var buttons = document.querySelectorAll(CHECKOUT_SELECTORS);
      var validButtons = [];
      
      buttons.forEach(function(btn) {
        // Filtrar apenas elementos válidos (não CSS links, etc)
        if (btn.tagName === 'BUTTON' || btn.tagName === 'A' || btn.tagName === 'INPUT' || 
            btn.getAttribute('role') === 'button') {
          validButtons.push(btn);
        }
      });
      
      log('Elementos de checkout encontrados na página:', validButtons.length);
      
      validButtons.forEach(function(btn, i) {
        if (btn.__ccAttached) return;
        btn.__ccAttached = true;
        
        log('  - ' + btn.outerHTML.substring(0, 80));
        
        btn.addEventListener('click', function(e) {
          log('>>> BOTÃO checkout clicado diretamente!');
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          // Prevenir submit do form pai
          var form = btn.closest('form');
          if (form) {
            form.onsubmit = function() { return false; };
          }
          
          redirectWithCart();
          return false;
        }, true);
      });
    } catch (e) {}
  }

  // Executar imediatamente e após carregamento
  attachToCheckoutForms();
  attachToCheckoutButtons();
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      attachToCheckoutForms();
      attachToCheckoutButtons();
    });
  }
  
  window.addEventListener('load', function() {
    setTimeout(function() {
      attachToCheckoutForms();
      attachToCheckoutButtons();
    }, 500);
    setTimeout(function() {
      attachToCheckoutForms();
      attachToCheckoutButtons();
    }, 1500);
  });

  // MutationObserver para elementos dinâmicos (cart drawer, etc)
  try {
    var observer = new MutationObserver(function(mutations) {
      var shouldReattach = false;
      mutations.forEach(function(m) {
        if (m.addedNodes.length > 0) shouldReattach = true;
      });
      if (shouldReattach) {
        setTimeout(function() {
          attachToCheckoutForms();
          attachToCheckoutButtons();
        }, 100);
      }
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    log('✓ MutationObserver ativo');
  } catch (e) {}

})();
</script>